# 数据湖多智能体系统架构图

## 系统整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                     数据湖多智能体系统                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐              │
│  │    CLI      │    │     API     │    │   Web UI    │              │
│  │   Interface │    │   Server    │    │  (Future)   │              │
│  └─────────────┘    └─────────────┘    └─────────────┘              │
│         │                   │                   │                   │
│         └───────────────────┼───────────────────┘                   │
│                             │                                       │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                 LangGraph Workflow Engine                       │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                             │                                       │
└─────────────────────────────┼───────────────────────────────────────┘
                              │
┌─────────────────────────────┼───────────────────────────────────────┐
│                    多智能体协作层                                     │
│                             │                                       │
│     ┌──────────────────────────────────────────────────────────┐    │
│     │                 PlannerAgent                             │    │
│     │              任务理解 & 策略选择                          │    │
│     └──────────────────┬───────────────────────────────────────┘    │
│                        │                                            │
│     ┌──────────────────┼────────────────────────────────────────┐   │
│     │  Strategy Router │                                        │   │
│     └──────────────────┼────────────────────────────────────────┘   │
│                        │                                            │
│         ┌──────────────┴──────────────┐                             │
│         │                             │                             │
│  ┌──────▼──────┐              ┌───────▼──────┐                      │
│  │ BOTTOM_UP   │              │  TOP_DOWN    │                      │
│  │  Strategy   │              │  Strategy    │                      │
│  └─────────────┘              └──────────────┘                      │
│         │                             │                             │
│  ┌──────▼──────┐              ┌───────▼──────┐                      │
│  │ Column      │              │ Table        │                      │
│  │ Discovery   │              │ Discovery    │                      │
│  │ Agent       │              │ Agent        │                      │
│  └─────────────┘              └──────────────┘                      │
│         │                             │                             │
│  ┌──────▼──────┐              ┌───────▼──────┐                      │
│  │ Table       │              │ Table        │                      │
│  │ Aggregation │              │ Matching     │                      │
│  │ Agent       │              │ Agent        │                      │
│  └─────────────┘              └──────────────┘                      │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────┼───────────────────────────────────────┐
│                      工具层 Tools Layer                             │
│                             │                                       │
│  ┌─────────────┐    ┌───────▼──────┐    ┌─────────────┐            │
│  │ Embedding   │    │ Vector       │    │ Value       │            │
│  │ Generator   │    │ Search       │    │ Search      │            │
│  │             │    │ Engine       │    │ Engine      │            │
│  └─────────────┘    └──────────────┘    └─────────────┘            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────┼───────────────────────────────────────┐
│                      存储层 Storage Layer                           │
│                             │                                       │
│  ┌─────────────┐    ┌───────▼──────┐    ┌─────────────┐            │
│  │ FAISS       │    │ Metadata     │    │ Cache       │            │
│  │ Vector DB   │    │ Storage      │    │ Storage     │            │
│  │             │    │ (Pickle)     │    │             │            │
│  └─────────────┘    └──────────────┘    └─────────────┘            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────┼───────────────────────────────────────┐
│                     外部服务层                                       │
│                             │                                       │
│  ┌─────────────┐    ┌───────▼──────┐    ┌─────────────┐            │
│  │ Google      │    │ OpenAI       │    │ Anthropic   │            │
│  │ Gemini API  │    │ API          │    │ Claude API  │            │
│  │ (Primary)   │    │ (Optional)   │    │ (Optional)  │            │
│  └─────────────┘    └──────────────┘    └─────────────┘            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## 智能体协作流程

### BOTTOM_UP 策略 (基于列匹配)

```
用户查询 (包含列信息)
         │
         ▼
┌─────────────────┐
│  PlannerAgent   │ ── 分析查询意图 ──→ 选择 BOTTOM_UP 策略
└─────────────────┘
         │
         ▼
┌─────────────────┐
│ColumnDiscovery  │ ── 语义搜索 + 值重叠 ──→ 找到匹配的列
│     Agent       │
└─────────────────┘
         │
         ▼
┌─────────────────┐
│ TableAggregation│ ── 聚合列匹配结果 ──→ 计算表级别相似度
│     Agent       │
└─────────────────┘
         │
         ▼
      最终结果
```

### TOP_DOWN 策略 (基于表匹配)

```
用户查询 (包含表信息)
         │
         ▼
┌─────────────────┐
│  PlannerAgent   │ ── 分析查询意图 ──→ 选择 TOP_DOWN 策略
└─────────────────┘
         │
         ▼
┌─────────────────┐
│ TableDiscovery  │ ── 向量搜索 + 关键词 ──→ 找到相似的表
│     Agent       │
└─────────────────┘
         │
         ▼
┌─────────────────┐
│ TableMatching   │ ── 详细比较 ──→ 计算表对表相似度
│     Agent       │
└─────────────────┘
         │
         ▼
      最终结果
```

## 核心组件详细说明

### 1. PlannerAgent (规划智能体)
- **输入**: 用户查询 + 数据集信息
- **功能**: 
  - 理解用户意图 (JOIN vs UNION)
  - 选择处理策略 (BOTTOM_UP vs TOP_DOWN)
  - 路由到相应的智能体链
- **输出**: 包含策略信息的AgentState

### 2. ColumnDiscoveryAgent (列发现智能体)
- **输入**: 查询列信息
- **功能**:
  - 语义相似度搜索 (基于列名和描述)
  - 值重叠度检测 (基于样本值)
  - 并行处理多个查询列
- **输出**: 列级别匹配结果

### 3. TableAggregationAgent (表聚合智能体)
- **输入**: 列匹配结果
- **功能**:
  - 将列匹配聚合为表级别得分
  - 应用匹配阈值过滤
  - 排序和排名
- **输出**: 表级别匹配结果

### 4. TableDiscoveryAgent (表发现智能体)
- **输入**: 查询表信息或关键词
- **功能**:
  - 基于表元数据的向量搜索
  - 关键词匹配发现
  - 索引管理 (保存/加载)
- **输出**: 候选表列表

### 5. TableMatchingAgent (表匹配智能体)
- **输入**: 候选表列表
- **功能**:
  - 表对表详细比较
  - 结构相似度计算
  - LLM辅助语义匹配
- **输出**: 最终匹配结果

## 技术特性

### API密钥轮换管理
```
┌─────────────────┐
│ ApiKeyManager   │
├─────────────────┤
│ - 3个Gemini keys│
│ - 自动切换      │
│ - 错误检测      │
│ - 冷却机制      │
└─────────────────┘
```

### 向量搜索引擎
```
┌─────────────────┐
│ VectorSearch    │
├─────────────────┤
│ - FAISS索引     │
│ - 384维嵌入     │
│ - 持久化存储    │
│ - 相似度查询    │
└─────────────────┘
```

### 配置管理
```
┌─────────────────┐
│ Settings        │
├─────────────────┤
│ - config.yml    │
│ - .env文件      │
│ - 动态配置      │
│ - 环境变量      │
└─────────────────┘
```

## 数据流向

1. **输入**: 用户查询 + JSON格式的表/列数据
2. **处理**: 多智能体协作处理
3. **计算**: 向量搜索 + LLM推理
4. **输出**: 匹配结果 (JSON/Markdown/Table格式)

## 使用场景

### JOIN操作 (BOTTOM_UP)
- 用户提供查询列
- 系统找到具有相似列的表
- 适用于精确的关系连接

### UNION操作 (TOP_DOWN)
- 用户提供查询表或关键词
- 系统找到结构相似的表
- 适用于数据合并和整合

这个架构设计实现了灵活的多智能体协作，支持不同的数据发现策略，并具有良好的扩展性和容错性。