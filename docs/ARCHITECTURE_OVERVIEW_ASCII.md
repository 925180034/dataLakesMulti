# 数据湖多智能体系统架构概览（ASCII版）

本文档提供ASCII格式的系统架构图，方便在终端和纯文本环境中查看。

## 1. 系统整体架构

```
┌──────────────────────────────────────────────────────────────────────┐
│                           用户交互层                                   │
├────────────────┬─────────────────┬───────────────────────────────────┤
│   CLI接口      │   FastAPI接口    │         配置管理                  │
└────────────────┴─────────────────┴───────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────────────┐
│                         工作流引擎层                                   │
├────────────────────────────────────────────────────────────────────┤
│                    LangGraph 工作流编排引擎                          │
├──────────────────────┬────────────────────────────────────────────┤
│  OptimizedWorkflow   │       UltraOptimizedWorkflow                │
└──────────────────────┴────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────────────┐
│                       多智能体系统                                     │
├──────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  ┌─────────────┐                                ┌─────────────┐      │
│  │PlannerAgent │◄──────────────────────────────►│TableMatching│      │
│  │  (路由)     │                                │   Agent     │      │
│  └─────┬───────┘                                └──────▲──────┘      │
│        │                                                │              │
│    ┌───▼────┬──────────┐                    ┌──────────┴──────┐      │
│    │        │          │                    │                  │      │
│ ┌──▼───┐ ┌─▼──┐   ┌───▼──┐            ┌───▼──┐          ┌───▼──┐   │
│ │Column│ │Table│   │ Table│            │Table │          │Table │   │
│ │Disc. │ │Disc.│   │ Agg. │            │Match │          │Valid.│   │
│ └──┬───┘ └─┬──┘   └───┬──┘            └──────┘          └──────┘   │
│    │       │           │                                              │
└────┼───────┼───────────┼──────────────────────────────────────────────┘
     │       │           │
     ▼       ▼           ▼
┌──────────────────────────────────────────────────────────────────────┐
│                     三层加速架构                                       │
├──────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  Layer 1: 元数据过滤          Layer 2: 向量搜索      Layer 3: LLM验证  │
│  ┌──────────────┐           ┌──────────────┐      ┌──────────────┐  │
│  │ MetadataFilter│ ───────► │  HNSW/FAISS  │ ───► │SmartLLMMatcher│  │
│  │   (<10ms)    │           │   (<100ms)   │      │    (<3s)     │  │
│  └──────────────┘           └──────────────┘      └──────────────┘  │
│     10,000表                    1,000表                50表           │
│        ↓                           ↓                    ↓             │
│     1,000表                      50表                 10表            │
│                                                                        │
└──────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────────────┐
│                       优化组件层                                       │
├────────────────┬──────────────┬──────────────┬───────────────────────┤
│   多级缓存     │   批处理器    │  并行处理器   │     性能监控          │
│  ┌─────────┐  │ ┌──────────┐ │ ┌──────────┐ │  ┌──────────┐       │
│  │L1:Memory│  │ │  Batch    │ │ │ Parallel │ │  │Performance│       │
│  │L2:Redis │  │ │   LLM     │ │ │   Batch  │ │  │  Monitor  │       │
│  │L3:Disk  │  │ │ Processor │ │ │ Processor│ │  │           │       │
│  └─────────┘  │ └──────────┘ │ └──────────┘ │  └──────────┘       │
└────────────────┴──────────────┴──────────────┴───────────────────────┘
```

## 2. 数据流示意图

```
用户查询                         系统处理                          输出结果
────────                         ────────                          ────────

[查询输入]                    ┌──────────────┐                 [匹配结果]
  Table: A      ─────────►   │   查询解析    │   ─────────►     Tables:
  Column: X                   └──────┬───────┘                  - B (95%)
  Type: Join                        │                           - C (87%)
                                    ▼                           - D (76%)
                           ┌──────────────┐
                           │  策略选择     │                    [评价指标]
                           └──────┬───────┘                     Precision: 0.85
                                  │                             Recall: 0.78
                    ┌─────────────┼─────────────┐              F1-Score: 0.81
                    ▼                           ▼
          ┌──────────────┐            ┌──────────────┐
          │  Bottom-Up   │            │   Top-Down   │
          │  (列优先)     │            │  (表优先)     │
          └──────┬───────┘            └──────┬───────┘
                 │                            │
                 └─────────┬──────────────────┘
                           ▼
                  ┌──────────────┐
                  │ 三层加速处理  │
                  └──────┬───────┘
                         │
         ┌───────────────┼───────────────┐
         ▼               ▼               ▼
    [元数据过滤]    [向量搜索]      [LLM验证]
     10,000→1,000   1,000→50        50→10
                         │
                         ▼
                   [最终结果]
```

## 3. 查询处理时序图

```
时间轴 ──────────────────────────────────────────────────────────────►

用户      CLI      工作流     Planner    Discovery   Aggregation  Matching
 │         │         │          │           │           │           │
 ├────────►│         │          │           │           │           │
 │ 查询    │         │          │           │           │           │
 │         ├────────►│          │           │           │           │
 │         │  初始化 │          │           │           │           │
 │         │         ├─────────►│           │           │           │
 │         │         │ 分析意图 │           │           │           │
 │         │         │          ├──────────►│           │           │
 │         │         │          │  执行发现  │           │           │
 │         │         │          │           ├──────────►│           │
 │         │         │          │           │   聚合    │           │
 │         │         │          │           │           ├──────────►│
 │         │         │          │           │           │   验证    │
 │         │         │          │           │           │◄──────────┤
 │         │         │          │           │◄──────────┤           │
 │         │         │          │◄──────────┤           │           │
 │         │         │◄─────────┤           │           │           │
 │         │◄────────┤          │           │           │           │
 │◄────────┤ 结果    │          │           │           │           │
 │         │         │          │           │           │           │

 时间: 0ms        100ms      500ms       1000ms      2000ms      3000ms
```

## 4. 三层加速架构处理流程

```
                        查询输入
                           │
                           ▼
        ┌─────────────────────────────────────┐
        │         Layer 1: 元数据过滤          │
        │                                      │
        │  输入: 10,000+ 表                    │
        │  ┌─────────────────────────────┐    │
        │  │ • 列名匹配                  │    │
        │  │ • 数据类型兼容              │    │
        │  │ • 表结构相似度              │    │
        │  │ • 统计特征筛选              │    │
        │  └─────────────────────────────┘    │
        │  输出: ~1,000 表 (10倍减少)          │
        │  耗时: <10ms                         │
        └─────────────────┬────────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────────┐
        │         Layer 2: 向量搜索           │
        │                                      │
        │  输入: ~1,000 表                     │
        │  ┌─────────────────────────────┐    │
        │  │ • 语义嵌入生成              │    │
        │  │ • HNSW高维搜索              │    │
        │  │ • 余弦相似度计算            │    │
        │  │ • Top-K选择 (K=50)          │    │
        │  └─────────────────────────────┘    │
        │  输出: ~50 表 (20倍减少)             │
        │  耗时: <100ms                        │
        └─────────────────┬────────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────────┐
        │         Layer 3: LLM验证            │
        │                                      │
        │  输入: ~50 表                        │
        │  ┌─────────────────────────────┐    │
        │  │ • 智能规则预判              │    │
        │  │ • 批量LLM调用              │    │
        │  │ • 并行处理(20并发)          │    │
        │  │ • 结果排序和筛选            │    │
        │  └─────────────────────────────┘    │
        │  输出: ~10 表 (最终结果)             │
        │  耗时: <3s                           │
        └─────────────────┬────────────────────┘
                          │
                          ▼
                      最终匹配结果
```

## 5. 性能优化策略

```
                    性能优化组件架构
┌──────────────────────────────────────────────────────────────┐
│                                                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  缓存系统     │  │  批处理系统   │  │  并行处理     │       │
│  │              │  │              │  │              │       │
│  │ L1: 内存缓存 │  │ 查询队列     │  │ 任务分割器   │       │
│  │  ↓           │  │  ↓           │  │  ↓           │       │
│  │ L2: Redis   │  │ 批量组合器   │  │ Worker Pool  │       │
│  │  ↓           │  │  ↓           │  │  ↓           │       │
│  │ L3: 磁盘缓存 │  │ 批量LLM调用  │  │ 结果合并器   │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
│                                                                │
│  缓存命中率: >95%   批大小: 10      并发数: 20               │
│  响应加速: 100x     调用减少: 10x    吞吐提升: 20x           │
│                                                                │
└──────────────────────────────────────────────────────────────┘
```

## 6. 系统部署拓扑

```
                        互联网
                          │
                    ┌─────┴─────┐
                    │  负载均衡  │
                    │  (Nginx)   │
                    └─────┬─────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
   ┌────▼───┐       ┌────▼───┐       ┌────▼───┐
   │ API-1  │       │ API-2  │       │ API-N  │
   │FastAPI │       │FastAPI │       │FastAPI │
   └────┬───┘       └────┬───┘       └────┬───┘
        │                 │                 │
        └─────────────────┼─────────────────┘
                          │
                ┌─────────┴─────────┐
                │                   │
          ┌─────▼─────┐       ┌────▼────┐
          │   Redis    │       │  FAISS  │
          │   Cache    │       │  Index  │
          └───────────┘       └─────────┘
                │                   │
                └─────────┬─────────┘
                          │
                    ┌─────▼─────┐
                    │ PostgreSQL│
                    │  Metadata  │
                    └───────────┘
```

## 总结

本系统采用多智能体协作架构，通过三层加速机制实现高效的数据湖查询匹配：

- **查询速度**: <3秒（目标），实际达到1-2秒
- **匹配准确率**: Precision ~40-75%, Recall ~23-75%
- **系统容量**: 支持10,000+表规模
- **并发能力**: 支持20+并发查询
- **缓存效果**: 95%+命中率，100倍加速

系统的核心创新在于将传统的暴力搜索转化为渐进式筛选，通过元数据→向量→LLM的三层过滤，在保证准确性的同时大幅提升性能。